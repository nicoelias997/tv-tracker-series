---
// AppBar - Fixed top navigation with status-based links
import AppBarAuth from './AppBarAuth';
import NavLinks from './NavLinks';
import SessionInitializer from './SessionInitializer';

const currentPath = Astro.url.pathname;
---

<!-- Session Initializer - Ensures auth state is loaded on every page -->
<SessionInitializer client:only="preact" />

<nav class="app-bar fixed top-0 left-0 right-0 z-50 shadow-lg" style="background: linear-gradient(135deg, #8b7fc7 0%, #b4a9db 100%);" role="navigation" aria-label="Main navigation">
  <div class="container mx-auto px-4">
    <div class="flex items-center justify-between h-16">
      <!-- Logo / Brand -->
      <a
        href="/"
        class="flex items-center space-x-3 text-white font-bold text-xl hover:opacity-90 transition-opacity focus:outline-none focus:ring-2 focus:ring-white rounded px-2 py-1"
        aria-label="Go to home page"
      >
        <span class="text-2xl" aria-hidden="true">ðŸŽ¬</span>
        <span class="hidden sm:inline">Media Tracker</span>
        <span class="sm:hidden">Media</span>
      </a>

      <!-- Desktop Navigation -->
      <div class="hidden md:flex items-center space-x-1" role="menubar">
        <div class="flex space-x-1">
          <NavLinks currentPath={currentPath} client:load />
        </div>

        <!-- Auth Component -->
        <div class="ml-4 pl-4 border-l border-white/20">
          <AppBarAuth client:load />
        </div>
      </div>

      <!-- Mobile Menu Button -->
      <button
        id="mobile-menu-button"
        class="md:hidden text-white p-2 rounded-lg hover:bg-white/10 transition-colors focus:outline-none focus:ring-2 focus:ring-white"
        aria-label="Toggle mobile menu"
        aria-expanded="false"
        aria-controls="mobile-menu"
      >
        <svg
          class="w-6 h-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          aria-hidden="true"
        >
          <path
            id="menu-open-icon"
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M4 6h16M4 12h16M4 18h16"
          />
          <path
            id="menu-close-icon"
            class="hidden"
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"
          />
        </svg>
      </button>
    </div>

    <!-- Mobile Navigation -->
    <div
      id="mobile-menu"
      class="md:hidden hidden pb-4"
      role="menu"
    >
      <NavLinks currentPath={currentPath} isMobile={true} client:load />

      <!-- Mobile Auth -->
      <div class="mt-4 pt-4 border-t border-white/20 px-4">
        <AppBarAuth client:load />
      </div>
    </div>
  </div>
</nav>

<!-- Spacer to prevent content from going under fixed nav -->
<div class="h-16" aria-hidden="true"></div>

<script>
  // Mobile menu toggle
  const menuButton = document.getElementById('mobile-menu-button');
  const mobileMenu = document.getElementById('mobile-menu');
  const menuOpenIcon = document.getElementById('menu-open-icon');
  const menuCloseIcon = document.getElementById('menu-close-icon');

  if (menuButton && mobileMenu && menuOpenIcon && menuCloseIcon) {
    menuButton.addEventListener('click', () => {
      const isExpanded = menuButton.getAttribute('aria-expanded') === 'true';

      menuButton.setAttribute('aria-expanded', String(!isExpanded));
      mobileMenu.classList.toggle('hidden');
      menuOpenIcon.classList.toggle('hidden');
      menuCloseIcon.classList.toggle('hidden');
    });

    // Close mobile menu when clicking a link
    const mobileLinks = mobileMenu.querySelectorAll('a');
    mobileLinks.forEach(link => {
      link.addEventListener('click', () => {
        mobileMenu.classList.add('hidden');
        menuOpenIcon.classList.remove('hidden');
        menuCloseIcon.classList.add('hidden');
        menuButton.setAttribute('aria-expanded', 'false');
      });
    });

    // Close mobile menu on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !mobileMenu.classList.contains('hidden')) {
        mobileMenu.classList.add('hidden');
        menuOpenIcon.classList.remove('hidden');
        menuCloseIcon.classList.add('hidden');
        menuButton.setAttribute('aria-expanded', 'false');
        menuButton.focus();
      }
    });
  }
</script>

<style>
  .app-bar {
    backdrop-filter: blur(10px);
  }

  .nav-link {
    position: relative;
  }

  .nav-link::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 50%;
    width: 0;
    height: 2px;
    background: white;
    transition: width 0.3s ease, left 0.3s ease;
  }

  .nav-link:hover::after {
    width: 80%;
    left: 10%;
  }
</style>
