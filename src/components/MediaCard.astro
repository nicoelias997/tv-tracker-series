---
import { getPosterUrl, formatRating } from '../services/tmdb';
import StatusActions from './StatusActions';
import type { MediaType } from '../types/Media';

interface Props {
  tmdbId: number;
  title: string;
  posterPath: string | null;
  releaseYear: string;
  rating: number;
  mediaType: MediaType;
  showActions?: boolean;
  currentStatus?: 'want_to_watch' | 'watching' | 'completed' | null;
}

const {
  tmdbId,
  title,
  posterPath,
  releaseYear,
  rating,
  mediaType,
  showActions = true,
  currentStatus = null
} = Astro.props;

const posterUrl = getPosterUrl(posterPath);
const formattedRating = formatRating(rating);
---

<article
  class="media-card group bg-white rounded-xl overflow-hidden shadow-md hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1"
  data-tmdb-id={tmdbId}
  data-media-type={mediaType}
>
  <!-- Poster Image -->
  <div class="relative aspect-[2/3] overflow-hidden bg-gray-200">
    <img
      src={posterUrl}
      alt={`${title} poster`}
      class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
      loading="lazy"
    />

    <!-- Rating Badge -->
    {rating > 0 && (
      <div
        class="absolute top-2 right-2 bg-black/80 text-white px-2 py-1 rounded-lg text-sm font-bold backdrop-blur-sm flex items-center gap-1"
        aria-label={`Rating: ${formattedRating} out of 10`}
      >
        <svg
          class="w-4 h-4 text-yellow-400"
          fill="currentColor"
          viewBox="0 0 20 20"
          aria-hidden="true"
        >
          <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
        </svg>
        <span>{formattedRating}</span>
      </div>
    )}

    <!-- Media Type Badge -->
    <div
      class="absolute top-2 left-2 bg-purple-600/90 text-white px-2 py-1 rounded-lg text-xs font-semibold uppercase backdrop-blur-sm"
      aria-label={mediaType === 'movie' ? 'Movie' : 'TV Series'}
    >
      {mediaType === 'movie' ? 'ðŸŽ¬ Movie' : 'ðŸ“º TV'}
    </div>
  </div>

  <!-- Card Content -->
  <div class="p-4">
    <!-- Title -->
    <h3 class="font-bold text-lg text-gray-900 mb-1 line-clamp-2 min-h-[3.5rem]" title={title}>
      {title}
    </h3>

    <!-- Year -->
    <p class="text-gray-600 text-sm mb-3">
      {releaseYear || 'N/A'}
    </p>

    <!-- Action Buttons -->
    {showActions && (
      <StatusActions
        client:load
        tmdbId={tmdbId}
        title={title}
        posterPath={posterPath}
        releaseYear={releaseYear}
        rating={rating}
        mediaType={mediaType}
        currentStatus={currentStatus}
      />
    )}
  </div>
</article>

<style>
  .media-card {
    position: relative;
  }

  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Ensure consistent card height */
  .media-card {
    display: flex;
    flex-direction: column;
  }

  .media-card > div:last-child {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
  }
</style>
